<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محسّن قطع الألواح</title>
    <style>
        :root {
            --color-background: #fcfcf9;
            --color-surface: #fffffd;
            --color-text: #13343b;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-primary-active: #1a6873;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-card-border: rgba(94, 82, 64, 0.12);
            --color-error: #c0152f;
            --color-success: #21808d;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-primary-active: #2996a1;
                --color-border: rgba(119, 124, 124, 0.3);
                --color-card-border: rgba(119, 124, 124, 0.2);
                --color-error: #ff5459;
                --color-success: #32b8c6;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--color-primary);
            font-size: 2rem;
        }

        .subtitle {
            text-align: center;
            color: var(--color-text-secondary);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .card h2 {
            margin-bottom: 16px;
            font-size: 1.25rem;
            color: var(--color-text);
        }

        .panel-config {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--color-text);
        }

        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--color-background);
            color: var(--color-text);
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--color-card-border);
        }

        th {
            font-weight: 600;
            color: var(--color-text);
            background: var(--color-background);
        }

        td input[type="number"] {
            padding: 6px 10px;
        }

        td input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-card-border);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .error-message {
            color: var(--color-error);
            padding: 12px;
            background: rgba(192, 21, 47, 0.1);
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .canvas-container {
            margin: 20px 0;
            text-align: center;
            overflow-x: auto;
        }

        canvas {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: white;
            max-width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--color-background);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--color-card-border);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .instructions {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--color-background);
            border-radius: 6px;
            border-right: 3px solid var(--color-primary);
        }

        @media (max-width: 768px) {
            .panel-config {
                flex-direction: column;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>محسّن قطع الألواح</h1>
        <p class="subtitle">احسب أفضل طريقة لقطع الألواح وتقليل الهدر</p>

        <!-- Panel Configuration -->
        <div class="card">
            <h2>أبعاد اللوح الأساسي</h2>
            <div class="panel-config">
                <div class="input-group">
                    <label for="panelWidth">العرض (ملم)</label>
                    <input type="number" id="panelWidth" value="1220" min="1">
                </div>
                <div class="input-group">
                    <label for="panelHeight">الارتفاع (ملم)</label>
                    <input type="number" id="panelHeight" value="2440" min="1">
                </div>
            </div>
        </div>

        <!-- Requirements Table -->
        <div class="card">
            <h2>القطع المطلوبة</h2>
            <div style="overflow-x: auto;">
                <table id="piecesTable">
                    <thead>
                        <tr>
                            <th>العرض (ملم)</th>
                            <th>الارتفاع (ملم)</th>
                            <th>الكمية</th>
                            <th>دوران؟</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="piecesBody">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
            <button class="btn btn-secondary" onclick="addPiece()">إضافة قطعة</button>
            <div id="errorMessage" class="error-message"></div>
        </div>

        <!-- Control Buttons -->
        <div class="card">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateLayout()">حساب التخطيط</button>
                <button class="btn btn-secondary" onclick="resetLayout()">إعادة تعيين التخطيط</button>
                <button class="btn btn-secondary" onclick="clearAll()">مسح الكل</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="results">
            <div class="card">
                <h2>النتائج</h2>
                
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">الألواح المطلوبة</div>
                        <div class="stat-value" id="panelsRequired">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">نسبة الاستخدام</div>
                        <div class="stat-value" id="utilization">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">نسبة الهدر</div>
                        <div class="stat-value" id="wastePercent">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">إجمالي القطوع</div>
                        <div class="stat-value" id="totalCuts">0</div>
                    </div>
                </div>

                <!-- Canvas -->
                <div class="canvas-container">
                    <canvas id="layoutCanvas"></canvas>
                </div>
            </div>

            <!-- Cutting Instructions -->
            <div class="card">
                <h2>تعليمات القطع</h2>
                <ol id="instructions" class="instructions"></ol>
            </div>
        </div>
    </div>

    <script>
        let pieces = [];
        let pieceIdCounter = 0;
        const colors = ['#4A90E2', '#7ED321', '#F5A623', '#D0021B', '#BD10E0', '#50E3C2', '#B8E986', '#F8E71C'];

        // Convert Western numerals to Arabic
        function toArabicNumerals(num) {
            const arabicNums = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).replace(/\d/g, d => arabicNums[d]);
        }

        // Initialize with one empty row
        window.onload = function() {
            addPiece();
        };

        function addPiece() {
            const tbody = document.getElementById('piecesBody');
            const row = tbody.insertRow();
            const id = pieceIdCounter++;
            
            row.innerHTML = `
                <td><input type="number" class="piece-width" value="300" min="1" data-id="${id}"></td>
                <td><input type="number" class="piece-height" value="200" min="1" data-id="${id}"></td>
                <td><input type="number" class="piece-quantity" value="1" min="1" data-id="${id}"></td>
                <td><input type="checkbox" class="piece-rotate" data-id="${id}" checked></td>
                <td><button class="btn btn-danger" onclick="deletePiece(this)">حذف</button></td>
            `;
        }

        function deletePiece(btn) {
            btn.closest('tr').remove();
        }

        function clearAll() {
            document.getElementById('piecesBody').innerHTML = '';
            document.getElementById('panelWidth').value = 1220;
            document.getElementById('panelHeight').value = 2440;
            resetLayout();
            addPiece();
        }

        function resetLayout() {
            document.getElementById('results').classList.remove('show');
            hideError();
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function collectPieces() {
            pieces = [];
            const widths = document.querySelectorAll('.piece-width');
            const heights = document.querySelectorAll('.piece-height');
            const quantities = document.querySelectorAll('.piece-quantity');
            const rotates = document.querySelectorAll('.piece-rotate');

            for (let i = 0; i < widths.length; i++) {
                const width = parseInt(widths[i].value);
                const height = parseInt(heights[i].value);
                const quantity = parseInt(quantities[i].value);
                const canRotate = rotates[i].checked;

                if (width > 0 && height > 0 && quantity > 0) {
                    for (let j = 0; j < quantity; j++) {
                        pieces.push({
                            id: pieces.length,
                            width: width,
                            height: height,
                            canRotate: canRotate,
                            color: colors[pieces.length % colors.length]
                        });
                    }
                }
            }

            return pieces;
        }

        function calculateLayout() {
            hideError();
            
            const panelWidth = parseInt(document.getElementById('panelWidth').value);
            const panelHeight = parseInt(document.getElementById('panelHeight').value);

            if (panelWidth <= 0 || panelHeight <= 0) {
                showError('الرجاء إدخال أبعاد صحيحة للوح');
                return;
            }

            const pieces = collectPieces();

            if (pieces.length === 0) {
                showError('الرجاء إضافة قطع قبل الحساب');
                return;
            }

            // Check if any piece is too large
            for (let piece of pieces) {
                const fitsNormally = piece.width <= panelWidth && piece.height <= panelHeight;
                const fitsRotated = piece.canRotate && piece.height <= panelWidth && piece.width <= panelHeight;
                
                if (!fitsNormally && !fitsRotated) {
                    showError(`القطعة ${toArabicNumerals(piece.width)}×${toArabicNumerals(piece.height)} ملم كبيرة جداً بالنسبة للوح`);
                    return;
                }
            }

            // Sort pieces by area (largest first)
            pieces.sort((a, b) => (b.width * b.height) - (a.width * a.height));

            // Pack pieces using guillotine algorithm
            const panels = packPieces(pieces, panelWidth, panelHeight);

            if (panels.length === 0) {
                showError('لا يمكن وضع جميع القطع. جرب لوح أكبر');
                return;
            }

            // Calculate statistics
            const totalPanelArea = panels.length * panelWidth * panelHeight;
            const totalPieceArea = pieces.reduce((sum, p) => sum + (p.width * p.height), 0);
            const wasteArea = totalPanelArea - totalPieceArea;
            const wastePercent = (wasteArea / totalPanelArea * 100).toFixed(1);
            const utilization = (100 - wastePercent).toFixed(1);

            // Update statistics
            document.getElementById('panelsRequired').textContent = toArabicNumerals(panels.length);
            document.getElementById('utilization').textContent = toArabicNumerals(utilization) + '%';
            document.getElementById('wastePercent').textContent = toArabicNumerals(wastePercent) + '%';
            document.getElementById('totalCuts').textContent = toArabicNumerals(pieces.length * 2);

            // Draw layout
            drawLayout(panels, panelWidth, panelHeight);

            // Generate instructions
            generateInstructions(panels);

            // Show results
            document.getElementById('results').classList.add('show');
        }

        function packPieces(pieces, panelWidth, panelHeight) {
            const panels = [];
            const placedPieces = [];

            for (let piece of pieces) {
                let placed = false;

                // Try to place in existing panels
                for (let panel of panels) {
                    if (tryPlacePiece(panel, piece, panelWidth, panelHeight)) {
                        placed = true;
                        break;
                    }
                }

                // Create new panel if needed
                if (!placed) {
                    const newPanel = {
                        index: panels.length,
                        pieces: [],
                        freeSpaces: [{x: 0, y: 0, width: panelWidth, height: panelHeight}]
                    };
                    
                    if (tryPlacePiece(newPanel, piece, panelWidth, panelHeight)) {
                        panels.push(newPanel);
                    } else {
                        return []; // Piece doesn't fit
                    }
                }
            }

            return panels;
        }

        function tryPlacePiece(panel, piece, panelWidth, panelHeight) {
            const orientations = piece.canRotate ? 
                [{w: piece.width, h: piece.height, rotated: false}, 
                 {w: piece.height, h: piece.width, rotated: true}] : 
                [{w: piece.width, h: piece.height, rotated: false}];

            for (let orientation of orientations) {
                for (let i = 0; i < panel.freeSpaces.length; i++) {
                    const space = panel.freeSpaces[i];
                    
                    if (orientation.w <= space.width && orientation.h <= space.height) {
                        // Place piece
                        panel.pieces.push({
                            ...piece,
                            x: space.x,
                            y: space.y,
                            width: orientation.w,
                            height: orientation.h,
                            rotated: orientation.rotated
                        });

                        // Update free spaces using guillotine split
                        panel.freeSpaces.splice(i, 1);
                        
                        // Add right space
                        if (space.width > orientation.w) {
                            panel.freeSpaces.push({
                                x: space.x + orientation.w,
                                y: space.y,
                                width: space.width - orientation.w,
                                height: orientation.h
                            });
                        }
                        
                        // Add top space
                        if (space.height > orientation.h) {
                            panel.freeSpaces.push({
                                x: space.x,
                                y: space.y + orientation.h,
                                width: space.width,
                                height: space.height - orientation.h
                            });
                        }

                        return true;
                    }
                }
            }

            return false;
        }

        function drawLayout(panels, panelWidth, panelHeight) {
            const canvas = document.getElementById('layoutCanvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate scaling
            const maxWidth = 1000;
            const scale = Math.min(maxWidth / panelWidth, 600 / panelHeight);
            const scaledWidth = panelWidth * scale;
            const scaledHeight = panelHeight * scale;
            const margin = 50;
            const panelSpacing = 30;

            // Set canvas size
            canvas.width = scaledWidth * Math.min(panels.length, 3) + margin * 2 + panelSpacing * (Math.min(panels.length, 3) - 1);
            canvas.height = scaledHeight * Math.ceil(panels.length / 3) + margin * 2 + panelSpacing * (Math.ceil(panels.length / 3) - 1);

            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw each panel
            panels.forEach((panel, index) => {
                const row = Math.floor(index / 3);
                const col = index % 3;
                const offsetX = margin + col * (scaledWidth + panelSpacing);
                const offsetY = margin + row * (scaledHeight + panelSpacing);

                // Draw panel outline
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(offsetX, offsetY, scaledWidth, scaledHeight);

                // Draw panel label
                ctx.fillStyle = '#666';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`اللوح ${toArabicNumerals(index + 1)}`, offsetX + scaledWidth / 2, offsetY - 10);

                // Draw pieces
                panel.pieces.forEach(piece => {
                    const x = offsetX + piece.x * scale;
                    const y = offsetY + piece.y * scale;
                    const w = piece.width * scale;
                    const h = piece.height * scale;

                    // Fill piece
                    ctx.fillStyle = piece.color;
                    ctx.globalAlpha = 0.7;
                    ctx.fillRect(x, y, w, h);
                    ctx.globalAlpha = 1;

                    // Border
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, w, h);

                    // Label
                    ctx.fillStyle = '#000';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(
                        `${toArabicNumerals(piece.width)}×${toArabicNumerals(piece.height)}`,
                        x + w / 2,
                        y + h / 2
                    );
                });
            });
        }

        function generateInstructions(panels) {
            const instructionsList = document.getElementById('instructions');
            instructionsList.innerHTML = '';
            let cutNumber = 1;

            panels.forEach((panel, panelIndex) => {
                if (panels.length > 1) {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>اللوح ${toArabicNumerals(panelIndex + 1)}:</strong>`;
                    instructionsList.appendChild(li);
                }

                panel.pieces.forEach(piece => {
                    const li = document.createElement('li');
                    li.textContent = `القطع ${toArabicNumerals(cutNumber++)}: قطع قطعة ${toArabicNumerals(piece.width)}×${toArabicNumerals(piece.height)} ملم عند الموضع (${toArabicNumerals(piece.x)}, ${toArabicNumerals(piece.y)})`;
                    instructionsList.appendChild(li);
                });
            });
        }
    </script>
</body>
</html>
